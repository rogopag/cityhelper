var LocalSettings;jQuery(function(a){main()});function main(){var f="/",p=null,k=null,c=null,g=null,n=null,j=null,h=null,d=null,b,a,i,m,q,l,e,o;b={map:null,d:null,objects:{},ZOOM:13,clusterMaxZoom:16,mng:null,icons:{},me:{},touch:false,is_not_touch:true,trafficLayer:null,trafficData:null,has_infobox_open:false,center_on_me:false,infoBox:null,init:function(){var r;p=this;p.hideAddressBar();p.touch=(typeof window.Touch!="undefined")?window.Touch:false;p.is_not_touch=(p.touch)?false:true;p.me.RATIO=2.07;p.me.RADIUS=3000;p.me.startlat=0;p.me.startlng=0;p.ajax_populate();p.map=p.drawMap();p.geolocate_me();jQuery("#map_canvas").ajaxComplete(function(s){r=p.fill_objects();p.mng=p.draw_markers(r);a.init(p.mng);p.manageZoom(r,p.mng);MainViewController.init();m.init(p.mng);q.init();e.init();o.init()})},geolocate_me:function(){if(navigator.geolocation){var s,r;s=navigator.geolocation.getCurrentPosition(function(t){startPos=t;p.me.startlat=startPos.coords.latitude;p.me.startlng=startPos.coords.longitude;p.me.startLocation=new google.maps.LatLng(p.me.startlat,p.me.startlng),size=p.map.getZoom()},function(t){alert("Error occurred. Error code: "+t.code)});r=navigator.geolocation.watchPosition(function(t){p.me.lat=t.coords.latitude;p.me.lng=t.coords.longitude;p.me.currentLocation=new google.maps.LatLng(p.me.lat,p.me.lng);var v=p.map.getZoom(),w,u;p.me.icon=LocalSettings.STATIC_URL+"images/me.png";w=new google.maps.MarkerImage(p.me.icon,null,null,null,new google.maps.Size(v,v*p.me.RATIO));if(typeof p.me.marker=="undefined"&&typeof p.me.circle=="undefined"){p.me.marker=new google.maps.Marker({position:p.me.currentLocation,map:p.map,title:"Here I am",icon:w,zIndex:google.maps.Marker.MAX_ZINDEX});u={strokeColor:"#FF0000",strokeOpacity:0.4,strokeWeight:2,fillColor:"#FF0000",fillOpacity:0.2,map:p.map,center:p.me.currentLocation,radius:p.me.RADIUS/p.ZOOM};p.me.circle=new google.maps.Circle(u)}else{p.me.marker.setPosition(p.me.currentLocation);p.me.circle.setCenter(p.me.currentLocation);p.me.circle.setRadius(p.me.RADIUS/p.map.getZoom())}if(p.center_on_me){p.map.setCenter(p.me.currentLocation)}},function(t){alert("Error occurred. Error code: "+t.code)},{enableHighAccuracy:true,maximumAge:10000,timeout:10000})}else{alert("Geolocation is not supported for this Browser/OS version yet.")}},manageZoom:function(r,s){google.maps.event.addListener(p.map,"zoom_changed",function(){var u=p.map.getZoom(),t=u*(u/10);if(u<=p.ZOOM){return false}image=new google.maps.MarkerImage(p.me.icon,null,null,null,new google.maps.Size(t,t*p.me.RATIO));p.me.circle.setRadius(p.me.RADIUS/u);p.me.marker.setIcon(image)})},hide_managers:function(r){$.each(r,function(s,t){if("hide" in t){t.hide()}})},drawMap:function(){var s=new google.maps.LatLng(45.07,7.68),r={backgroundColor:"#FFFFFF",zoom:p.ZOOM,navigationControl:false,mapTypeId:google.maps.MapTypeId.ROADMAP,center:s,mapTypeControl:false,panControl:p.is_not_touch,panControlOptions:{position:google.maps.ControlPosition.LEFT_CENTER},zoomControl:p.is_not_touch,zoomControlOptions:{style:google.maps.ZoomControlStyle.LARGE,position:google.maps.ControlPosition.LEFT_CENTER},scaleControl:p.is_not_touch,scaleControlOptions:{position:google.maps.ControlPosition.LEFT_CENTER},streetViewControl:p.is_not_touch,streetViewControlOptions:{position:google.maps.ControlPosition.LEFT_CENTER}};if(document.getElementById("map_canvas")){return new google.maps.Map(document.getElementById("map_canvas"),r)}},fill_objects:function(){var s=1,u=54,x;for(var t in p.d){p.objects[t]=[];p.icons[t]=LocalSettings.STATIC_URL+"images/map_icons.png";x=p.switch_parameters(t);v=new google.maps.MarkerImage(p.icons[t],new google.maps.Size(u,u),new google.maps.Point(x.icon,0),new google.maps.Point(0,0));for(var r in p.d[t]){var w={},v;w=(typeof p.d[t][r].fields!="undefined")?p.d[t][r].fields:p.d[t][r];w.type=t;w.icon_url=p.icons[t];w.marker=new google.maps.Marker({position:new google.maps.LatLng(w.lat,w.lng),title:w.name,icon:v,type:w.type,zIndex:x.index});w.has_infoBox=false;google.maps.event.addListener(w.marker,"click",(function(y){return function(){if(!y.has_infoBox){p.manage_info_box(y)}}})(w));p.objects[t].push(w);delete w}}return p.objects},manage_info_box:function(y){var w=y,t,r=document.createElement("div"),v=$('<div class="infoRow"></div>'),u=$('<div class="actionRow"></div>'),s,x;s=$.ninja.button({html:"Percorso",select:(null==c)?false:true}).select(function(){i.init();c.calculateRoute(w.lat,w.lng);return false}).deselect(function(){c.destroy();if(!w.has_infoBox&&!p.has_infobox_open){p.infoBox.close()}return false}),x=$.ninja.button({html:"Selected",select:true});v.text(w.name);u.append(s);$(r).append(v,u);var t={content:r,disableAutoPan:false,maxWidth:0,pixelOffset:new google.maps.Size(-140,0),zIndex:null,closeBoxMargin:"",closeBoxURL:"",infoBoxClearance:new google.maps.Size(1,1),isHidden:false,pane:"floatPane",enableEventPropagation:false};if(!w.has_infoBox&&!p.has_infobox_open){p.infoBox=new InfoBox(t);p.infoBox.open(p.map,w.marker);w.has_infoBox=true;p.has_infobox_open=true;google.maps.event.addListener(p.map,"click",(function(A,z){return function(){z.close();A.has_infoBox=false;p.has_infobox_open=false}})(w,p.infoBox))}return p.infoBox},close_info_box:function(){if(p.has_infobox_open){p.infoBox.close()}},switch_parameters:function(r){var s={};switch(r){case"hospitals":s.index=1001;s.ratio=1.5;s.cluster=0;s.icon=0;break;case"pharma":s.index=1001;s.ratio=1.5;s.cluster=38;s.icon=54;break;case"parkings":s.index=1000;s.ratio=1.5;s.cluster=76;s.icon=108;break;case"traffic":s.index=999;s.ratio=0.92;s.cluster=0;s.icon=108;break;case"veterinarians":s.index=999;s.ratio=0.92;s.cluster=114;s.icon=162;break}return s},draw_markers:function(v){var u={},x={};if(!v){return false}p.trafficLayer=new google.maps.TrafficLayer();p.trafficData=v.traffic;v.traffic=p.trafficLayer;for(var s in v){var t,w=p.switch_parameters(s);if(s!="traffic"){t=[{url:LocalSettings.STATIC_URL+"images/map_clusters.png",height:38,width:38,backgroundPosition:[w.cluster,0],textColor:"#ff0000",textSize:12}];u[s]=new MarkerClusterer(p.map,[],{styles:t,maxZoom:p.clusterMaxZoom})}else{u[s]=p.trafficLayer}x[s]=[];for(var r in v[s]){x[s].push(v[s][r].marker)}if(s!="traffic"){u[s].addMarkers(x[s])}}return u},ajax_populate:function(){var r={"do":"something"};$.ajax({type:"post",async:true,url:f,data:{data:JSON.stringify(r)},dataType:"json",error:function(s,u,t){},beforeSend:function(s){if(s&&s.overrideMimeType){s.overrideMimeType("application/j-son;charset=UTF-8")}},success:function(s,u,t){if(s){p.d=s}},complete:function(s,t){p.loader_hide()}})},loader_hide:function(){$("div#loading-gif").hide()},loader_show:function(){$("div#loading-gif").show()},hideAddressBar:function(){setTimeout(function(){window.scrollTo(0,1)},0)},};a={options:null,optionsSelect:null,disabled:null,dialogs_open:[],rows_selected:[],init:function(r){k=this;k.mngs=r;k.buttons=[];k.setSelectLayer()},setSelectLayer:function(){k.addButton();$("div.bt_4 span").append(k.options)},addButton:function(){k.options=$.ninja.drawer({html:'<div class="open"></div>',value:"",}).select(function(){k.controlOtherDrawers(this)}).deselect(function(){k.controlOtherDrawers(this)}),k.optionsSelect=$.ninja.drawer({html:"",select:true,value:"Selected"});k.options.addClass("hide-show-layers")},controlOtherDrawers:function(s){var r=s;if(k.dialogs_open.length>0){if(k.dialogs_open[0]==r){k.dialogs_open=[]}else{$(k.dialogs_open[0]).children(".nui-try").slideUp("fast",function(){$(this).prev().removeClass("nui-slc");k.dialogs_open=[];k.dialogs_open.push(r)})}}else{k.dialogs_open.push(r)}},purge_open:function(r){$(r).children(".nui-try").slideUp("fast",function(){$(this).prev().removeClass("nui-slc")})},purgeCssClass:function(r){var s=k.rows_selected;$.each(s,function(t,u){if(u!=r){u.removeClass("nui-slc")}})}};i={directionsService:new google.maps.DirectionsService(),directionDisplay:null,origin:null,destination:null,request:{},hasDirection:false,mode:google.maps.DirectionsTravelMode.DRIVING,init:function(){c=this;c.save=null;c.setRenderer()},destroy:function(){c.directionDisplay.setMap(null);c.directionDisplay.setPanel(null);c.hasDirection=false;c.setRenderer()},setRenderer:function(){c.directionDisplay=null;c.directionDisplay=new google.maps.DirectionsRenderer();c.directionDisplay.setMap(p.map);c.directionDisplay.setPanel(document.getElementById("directions-panel"));c.directionDisplay.setOptions({draggable:false,markerOptions:{visible:false}})},calculateRoute:function(u,s,v){var r,t;if(c.hasDirection){c.destroy()}r=(v)?v:p.me.currentLocation;t={origin:r,destination:new google.maps.LatLng(u,s),travelMode:c.mode,provideRouteAlternatives:true};c.directionsService.route(t,function(x,w){if(w==google.maps.DirectionsStatus.OK){c.directionDisplay.setDirections(x);c.hasDirection=true;c.save={};c.save.start_lat=x.routes[0].legs[0].start_location.lat();c.save.start_lng=x.routes[0].legs[0].start_location.lng();c.save.end_lat=x.routes[0].legs[0].end_location.lat();c.save.end_lng=x.routes[0].legs[0].end_location.lng()}})},switchMode:function(r){switch(r){case 1:c.mode=google.maps.DirectionsTravelMode.DRIVING;break;case 2:c.mode=google.maps.DirectionsTravelMode.WALKING;break;default:c.mode=google.maps.DirectionsTravelMode.DRIVING;break}}};m={options:null,optionsSelect:null,button:null,isSearchingForDirection:false,isCar:null,isCarSelect:null,isFeet:null,isFeetSelect:null,dialog:null,mngs:null,buttons:[],mng:{},init:function(r){g=this;g.mngs=r;g.setSelectLayer();g.enableDisableLayerView()},setSelectLayer:function(){g.addButton();$("div.bt_5 span").append(g.options);$("div.bt_5 div.open").append(g.isCar,g.isFeet,g.isMore)},addButton:function(){g.options=$.ninja.drawer({html:'<div class="open"></div>',value:""}).select(function(){i.init();g.isSearchingForDirection=true;k.controlOtherDrawers(this)}).deselect(function(){g.isSearchingForDirection=false;c.destroy();k.controlOtherDrawers(this)}),g.optionsSelect=$.ninja.drawer({html:"",select:true,value:"Selected"});g.options.addClass("directions-control-button");g.isCar=$.ninja.button({html:"Auto",select:true}).select(function(){k.purgeCssClass(g.isCar);c.switchMode(1);return false}).deselect(function(){c.switchMode(1);return false}),g.isCarSelect=$.ninja.button({html:"Selected",select:true});k.rows_selected.push(g.isCar);g.isFeet=$.ninja.button({html:"Piedi"}).select(function(){k.purgeCssClass(g.isFeet);c.switchMode(2);return false}).deselect(function(){c.switchMode(1);return false}),g.isFeetSelect=$.ninja.button({html:"Selected",select:true});k.rows_selected.push(g.isFeet);g.isMore=$.ninja.button({html:"Opzioni percorso"}).select(function(){$(this).removeClass("nui-slc");k.purge_open(g.options);g.dialog.attach();return false}).deselect(function(){return false}),g.isMoreSelect=$.ninja.button({html:"Selected",select:true});k.rows_selected.push(g.isMore)},enableDisableLayerView:function(){g.dialog=$.ninja.dialog({html:""}).detach(function(){});g.addButtons();$.each(g.buttons,function(r,s){for(var r in s){$(g.dialog).append(s[r].el)}})},addButtons:function(){var r=0;$.each(g.mngs,function(s,t){p.mng[s].mng=t;g.buttons[r]={};g.buttons[r][s]={};g.buttons[r][s].name=s;g.buttons[r][s].el=$.ninja.button({html:g.buttons[r][s].name,select:!("hide" in p.mng[s].mng)}).deselect(function(){if("hide" in p.mng[s].mng){p.trafficLayer.hide()}else{p.mng[s].cluster=p.mng[s].mng.getMarkers();p.mng[s].mng.clearMarkers()}}).select(function(){if("hide" in p.mng[s].mng){p.trafficLayer.setMap(p.map)}else{p.mng[s].mng.addMarkers(p.mng[s].cluster);p.mng[s].mng.repaint()}}),g.buttons[r][s].sel=$.ninja.button({html:"Selected",select:false});$(g.buttons[r][s].el).addClass(g.buttons[r][s].name+"-button");r++})},};q={options:null,optionsSelect:null,saveData:null,saveDataSelect:null,displayData:null,displayDataSelect:null,init:function(){j=this;j.setSelectLayer();l.init()},setSelectLayer:function(){j.addButton();$("div.bt_2 span").append(j.options);$("div.bt_2 div.open").append(j.saveData,j.displayData)},addButton:function(){j.options=$.ninja.drawer({html:'<div class="open"></div>',value:""}).deselect(function(){k.controlOtherDrawers(this);$(this).find("button").each(function(){$(this).removeClass("nui-slc")})}).select(function(){k.controlOtherDrawers(this)}),j.optionsSelect=$.ninja.drawer({html:"",value:"Selected"});j.saveData=$.ninja.button({html:"Salva"}).select(function(){n.saveData(j.saveData)}).deselect(function(){}),j.saveDataSelect=$.ninja.button({html:"Selected",select:true});j.displayData=$.ninja.button({html:"Carica"}).select(function(){n.getData(j.saveData)}).deselect(function(){}),j.displayDataSelect=$.ninja.button({html:"Selected",select:true})}};l={input:null,button:null,has_form:false,stored:[],init:function(){n=this;if(!n.has_storage()){alert("i do not store things, your data won't be saved");return false}},has_storage:function(){if(window.sessionStorage&&window.localStorage){return true}return false},saveData:function(r){if(c&&c.save){n.appendFormAndSave()}else{$(r).removeClass("nui-slc");alert("Build route before trying to save it!");return false}},appendFormAndSave:function(){n.input=$('<input type="text" name="save_path_name" value="Nome percorso" id="save_path_name" />');n.saveButton=$('<button type="button" id="save_path" value="Salva" />');if(!n.has_form){$("div#working-panel").append(n.input,n.saveButton).show(400,function(){n.has_form=true});n.input.click(function(){$(this).val("")})}n.saveButton.click(function(){if(n.input.val()=="Nome percorso"||n.input.val()==""){alert("Dai un nome al tuo percorso "+n.input.val());return false}else{try{window.localStorage.setObject(n.input.val(),c.save);alert("Il percorso "+n.input.val()+" &egrave; stato salvato")}catch(r){alert(r)}finally{n.removePanel()}}})},getData:function(u){var s,w,v=false;s=$.ninja.dialog({html:""}).detach(function(){});if(n.has_storage&&window.localStorage.length){var r=window.localStorage.length;s.attach().hide();for(var t=0;t<r;t++){n.stored[t]={};n.stored[t].key=window.localStorage.key(t);n.stored[t].obj=window.localStorage.getObject(n.stored[t].key);w=$('<div class="row" />');if(!v){w.text(n.stored[t].key);s.append(w).fadeIn(400,function(){v=true});w.bind("click",{index:t},function(y){if(!c){i.init()}var x=y.data.index,z=new google.maps.LatLng(n.stored[x].obj.start_lat,n.stored[x].obj.start_lng);c.calculateRoute(n.stored[x].obj.end_lat,n.stored[x].obj.end_lng,z);console.log("Clicked")})}}}else{alert("Non ci sono percorsi salvati")}},removePanel:function(){$("div#working-panel").empty().fadeOut(400,function(){n.has_form=false})}};e={options:null,optionsSelect:null,init:function(){setcenteronme=this;setcenteronme.setSelectLayer()},setSelectLayer:function(){setcenteronme.addButton();$("div.bt_1 span").append(setcenteronme.options)},addButton:function(){setcenteronme.options=$.ninja.button({html:"",value:""}).select(function(){p.center_on_me=true}).deselect(function(){p.center_on_me=false}),setcenteronme.optionsSelect=$.ninja.button({html:"",value:"Selected"})}};MainViewController={options:null,optionsSelect:null,displayMap:null,displayMapSelect:null,displayList:null,displayListSelect:null,displayTwin:null,displayTwinSelect:null,init:function(){d=this;d.setSelectLayer()},setSelectLayer:function(){d.addButton();$("div.bt_3 span").append(d.options);$("div.bt_3 div.open").append(d.displayMap,d.displayList,d.displayTwin)},addButton:function(){d.options=$.ninja.drawer({html:'<div class="open"></div>',value:""}).deselect(function(){k.controlOtherDrawers(this)}).select(function(){k.controlOtherDrawers(this)}),d.optionsSelect=$.ninja.drawer({html:"",value:"Selected"});d.displayMap=$.ninja.button({html:"Mappa",select:true}).select(function(){k.purgeCssClass(d.displayMap)}).deselect(function(){}),d.displayMapSelect=$.ninja.button({html:"Selected",select:true});k.rows_selected.push(d.displayMap);d.displayList=$.ninja.button({html:"Lista"}).select(function(){k.purgeCssClass(d.displayList)}).deselect(function(){}),d.displayListSelect=$.ninja.button({html:"Selected",select:true});k.rows_selected.push(d.displayList);d.displayTwin=$.ninja.button({html:"Combined"}).select(function(){k.purgeCssClass(d.displayTwin)}).deselect(function(){}),d.displayTwinSelect=$.ninja.button({html:"Selected",select:true});k.rows_selected.push(d.displayTwin)}};o={init:function(){h=this;h.set_styles()},set_styles:function(){if($(window).width()<=960){$("div.nui-try").css("width",$(window).width())}}};b.init()}Storage.prototype.setObject=function(a,b){this.setItem(a,JSON.stringify(b))};Storage.prototype.getObject=function(a){return JSON.parse(this.getItem(a))};google.maps.TrafficLayer.prototype.hide=function(){this.setMap(null)};